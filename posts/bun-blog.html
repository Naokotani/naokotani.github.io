
<!doctype html>
<html lang="en">


<head>
  <meta charset="UTF-8" />
  <title>Bun Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Chris Hughes&#39; developer blog focused on web development, programming, and technology." />
  <link rel="stylesheet" type="text/css" href="/static/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="/static/css/vars.css">
  <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
  <script>
    const theme = localStorage.getItem("pref-theme")
    if (theme === "dark") {
      document.documentElement.style.background = "#141414";
    } else if (theme === "light") {
      document.documentElement.style.background = "#fefefe";
    } else {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.style.background = "#141414";
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
        document.documentElement.style.background = "#fefefe";
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Libre&#43;Baskerville&amp;family=Source&#43;Sans&#43;Pro&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="shortcut icon" type="image/png" href="/static/icons/favicon-16x16.png" />
  <link rel="alternate" type="application/rss+xml" title="Bun Blog" href="/rss">
  <script src="/static/js/colors.js" defer></script>
  <script src="/static/js/menu.js" defer></script>
</head>


<header class="desktop">
  <nav>
    <a href="/">
      <h2>Chris Hughes dot Dev</h2>
    </a>
    <div class="social-links">
    
      <a href="/resume/resume.html">Resume</a>
    
    
      <a href="/about/about.html">About</a>
    
      
      <a href="https://github.com/Naokotani" target="_blank" rel="noopener noreferrer">
        GitHub
      </a>
      
      
      <a href="mailto: chris@chris-hughes.dev">
        <svg class="icon nav-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 640 640"><path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/></svg>
      </a>
      
      
      <a href="/rss.xml">
        <svg class="icon nav-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 640 640"><path d="M96 128C96 110.3 110.3 96 128 96C357.8 96 544 282.2 544 512C544 529.7 529.7 544 512 544C494.3 544 480 529.7 480 512C480 317.6 322.4 160 128 160C110.3 160 96 145.7 96 128zM96 480C96 444.7 124.7 416 160 416C195.3 416 224 444.7 224 480C224 515.3 195.3 544 160 544C124.7 544 96 515.3 96 480zM128 224C287.1 224 416 352.9 416 512C416 529.7 401.7 544 384 544C366.3 544 352 529.7 352 512C352 388.3 251.7 288 128 288C110.3 288 96 273.7 96 256C96 238.3 110.3 224 128 224z"/></svg>
      </a>
      
      <button id="theme-toggle">
        <svg class="icon nav-icon" id="moon" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M303.3 112.7C196.2 121.2 112 210.8 112 320C112 434.9 205.1 528 320 528C353.3 528 384.7 520.2 412.6 506.3C309.2 482.9 232 390.5 232 280C232 214.2 259.4 154.9 303.3 112.7zM64 320C64 178.6 178.6 64 320 64C339.4 64 358.4 66.2 376.7 70.3C386.6 72.5 394 80.8 395.2 90.8C396.4 100.8 391.2 110.6 382.1 115.2C321.5 145.4 280 207.9 280 280C280 381.6 362.4 464 464 464C469 464 473.9 463.8 478.8 463.4C488.9 462.6 498.4 468.2 502.6 477.5C506.8 486.8 504.6 497.6 497.3 504.6C451.3 548.8 388.8 576 320 576C178.6 576 64 461.4 64 320z"/></svg>
        <svg class="icon nav-icon" id="bulb" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M424.5 355.1C449 329.2 464 294.4 464 256C464 176.5 399.5 112 320 112C240.5 112 176 176.5 176 256C176 294.4 191 329.2 215.5 355.1C236.8 377.5 260.4 409.1 268.8 448L371.2 448C379.6 409 403.2 377.5 424.5 355.1zM459.3 388.1C435.7 413 416 443.4 416 477.7L416 496C416 540.2 380.2 576 336 576L304 576C259.8 576 224 540.2 224 496L224 477.7C224 443.4 204.3 413 180.7 388.1C148 353.7 128 307.2 128 256C128 150 214 64 320 64C426 64 512 150 512 256C512 307.2 492 353.7 459.3 388.1zM272 248C272 261.3 261.3 272 248 272C234.7 272 224 261.3 224 248C224 199.4 263.4 160 312 160C325.3 160 336 170.7 336 184C336 197.3 325.3 208 312 208C289.9 208 272 225.9 272 248z"/></svg>
      </button>
    </div>
  </nav>
</header>
<header class="mobile">
  <nav>
    <a href="/">
      <h2>Chris Hughes.Dev</h2>
    </a>
    <a href="javascript:void(0);" onclick="handleSocial()">
      <i class="fa fa-bars menu"></i>
    </a>
  </nav>
</header>
<div id="social-menu" style="display: none;">
  <div class="mobile-social">
    <a href="/rss">
      <svg xmlns="http://www.w2.org/2000/svg" fill="currentColor" viewBox="0 0 640 640"><path d="M96 128C96 110.3 110.3 96 128 96C357.8 96 544 282.2 544 512C544 529.7 529.7 544 512 544C494.3 544 480 529.7 480 512C480 317.6 322.4 160 128 160C110.3 160 96 145.7 96 128zM96 480C96 444.7 124.7 416 160 416C195.3 416 224 444.7 224 480C224 515.3 195.3 544 160 544C124.7 544 96 515.3 96 480zM128 224C287.1 224 416 352.9 416 512C416 529.7 401.7 544 384 544C366.3 544 352 529.7 352 512C352 388.3 251.7 288 128 288C110.3 288 96 273.7 96 256C96 238.3 110.3 224 128 224z"/></svg>
    </a>
    
    <a href="mailto: chris@chris-hughes.dev">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 640 640"><path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/></svg>
    </a>
    
    
    <a href="https://github.com/Naokotani" target="_blank" rel="noopener noreferrer">
      <svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M237.9 461.4C237.9 463.4 235.6 465 232.7 465C229.4 465.3 227.1 463.7 227.1 461.4C227.1 459.4 229.4 457.8 232.3 457.8C235.3 457.5 237.9 459.1 237.9 461.4zM206.8 456.9C206.1 458.9 208.1 461.2 211.1 461.8C213.7 462.8 216.7 461.8 217.3 459.8C217.9 457.8 216 455.5 213 454.6C210.4 453.9 207.5 454.9 206.8 456.9zM251 455.2C248.1 455.9 246.1 457.8 246.4 460.1C246.7 462.1 249.3 463.4 252.3 462.7C255.2 462 257.2 460.1 256.9 458.1C256.6 456.2 253.9 454.9 251 455.2zM316.8 72C178.1 72 72 177.3 72 316C72 426.9 141.8 521.8 241.5 555.2C254.3 557.5 258.8 549.6 258.8 543.1C258.8 536.9 258.5 502.7 258.5 481.7C258.5 481.7 188.5 496.7 173.8 451.9C173.8 451.9 162.4 422.8 146 415.3C146 415.3 123.1 399.6 147.6 399.9C147.6 399.9 172.5 401.9 186.2 425.7C208.1 464.3 244.8 453.2 259.1 446.6C261.4 430.6 267.9 419.5 275.1 412.9C219.2 406.7 162.8 398.6 162.8 302.4C162.8 274.9 170.4 261.1 186.4 243.5C183.8 237 175.3 210.2 189 175.6C209.9 169.1 258 202.6 258 202.6C278 197 299.5 194.1 320.8 194.1C342.1 194.1 363.6 197 383.6 202.6C383.6 202.6 431.7 169 452.6 175.6C466.3 210.3 457.8 237 455.2 243.5C471.2 261.2 481 275 481 302.4C481 398.9 422.1 406.6 366.2 412.9C375.4 420.8 383.2 435.8 383.2 459.3C383.2 493 382.9 534.7 382.9 542.9C382.9 549.4 387.5 557.3 400.2 555C500.2 521.8 568 426.9 568 316C568 177.3 455.5 72 316.8 72zM169.2 416.9C167.9 417.9 168.2 420.2 169.9 422.1C171.5 423.7 173.8 424.4 175.1 423.1C176.4 422.1 176.1 419.8 174.4 417.9C172.8 416.3 170.5 415.6 169.2 416.9zM158.4 408.8C157.7 410.1 158.7 411.7 160.7 412.7C162.3 413.7 164.3 413.4 165 412C165.7 410.7 164.7 409.1 162.7 408.1C160.7 407.5 159.1 407.8 158.4 408.8zM190.8 444.4C189.2 445.7 189.8 448.7 192.1 450.6C194.4 452.9 197.3 453.2 198.6 451.6C199.9 450.3 199.3 447.3 197.3 445.4C195.1 443.1 192.1 442.8 190.8 444.4zM179.4 429.7C177.8 430.7 177.8 433.3 179.4 435.6C181 437.9 183.7 438.9 185 437.9C186.6 436.6 186.6 434 185 431.7C183.6 429.4 181 428.4 179.4 429.7z"/></svg>
    </a>
    
    
    <a href="/resume/resume.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 640 640"><path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/></svg>
    </a>
    
    <button id="theme-toggle-mobile">
        <svg id="moon-mobile" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M303.3 112.7C196.2 121.2 112 210.8 112 320C112 434.9 205.1 528 320 528C353.3 528 384.7 520.2 412.6 506.3C309.2 482.9 232 390.5 232 280C232 214.2 259.4 154.9 303.3 112.7zM64 320C64 178.6 178.6 64 320 64C339.4 64 358.4 66.2 376.7 70.3C386.6 72.5 394 80.8 395.2 90.8C396.4 100.8 391.2 110.6 382.1 115.2C321.5 145.4 280 207.9 280 280C280 381.6 362.4 464 464 464C469 464 473.9 463.8 478.8 463.4C488.9 462.6 498.4 468.2 502.6 477.5C506.8 486.8 504.6 497.6 497.3 504.6C451.3 548.8 388.8 576 320 576C178.6 576 64 461.4 64 320z"/></svg>
        <svg id="bulb-mobile" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M424.5 355.1C449 329.2 464 294.4 464 256C464 176.5 399.5 112 320 112C240.5 112 176 176.5 176 256C176 294.4 191 329.2 215.5 355.1C236.8 377.5 260.4 409.1 268.8 448L371.2 448C379.6 409 403.2 377.5 424.5 355.1zM459.3 388.1C435.7 413 416 443.4 416 477.7L416 496C416 540.2 380.2 576 336 576L304 576C259.8 576 224 540.2 224 496L224 477.7C224 443.4 204.3 413 180.7 388.1C148 353.7 128 307.2 128 256C128 150 214 64 320 64C426 64 512 150 512 256C512 307.2 492 353.7 459.3 388.1zM272 248C272 261.3 261.3 272 248 272C234.7 272 224 261.3 224 248C224 199.4 263.4 160 312 160C325.3 160 336 170.7 336 184C336 197.3 325.3 208 312 208C289.9 208 272 225.9 272 248z"/></svg>
    </button>
  </div>
</div>

<div id="contentDiv" class="contentDiv">

<summary>
  A simple blog website I made to try out Bun JS runtime.
</summary>
<h1>Bun Blog</h1>
<p><small class="date">Published: 14 Oct 2025 at 14:38 ADT</small></p>
<p><small class="tech">Bun | TypeScript</small></p>
<p>
I wasn&rsquo;t entirely happy with my <a href="https://chris-hughes.dev/blog/emacs-CMS.html">Emacs CMS</a> blog project. It felt like a bit of a disorganized prototype. I had HTML lurking around in my index.js along with all of the logic for the whole app, it could only handle uploading .png files. Using a web framework like Express also felt really excessive for such a simple application. I had a few people suggest that the <a href="https://bun.sh/">Bun</a> JavaScript runtime as an alternative to Node that was worth checking out so I decided to take another stab at the project using that, cheerio and mustache. The entire project is located <a href="https://github.com/Naokotani/bun-blog">here</a> on my GitHub.
</p>
<div id="outline-container-orge97ea70" class="outline-2">
<h2 id="orge97ea70">Bun vs. Node</h2>
<div class="outline-text-2" id="text-orge97ea70">
<p>
Bun is a really interesting alternative to Node. It comes with a really nice <code>Bun.serve()</code> method for receiving and sending HTTP requests and responses so its very easy to just make a nice REST api right out of the box. It also comes with the ability to read .env files into <code>process.env</code>, which is a nice convenience. It also has <code>Bun.file()</code>, which is a replacement for Nodes <code>fs.readFile()</code>, that can read relative paths without the need to join a relative path with <code>__dirname</code>. A lot of these things come down to convenience replacements for common tasks, but the Bun website makes some claims about being super fast. Without doing a lot more research, I will take that with a grain of salt for now.
</p>
</div>
</div>
<div id="outline-container-orgfc01004" class="outline-2">
<h2 id="orgfc01004">Getting the data from Emacs</h2>
<div class="outline-text-2" id="text-orgfc01004">
<p>
Similar to my other project I use the  following function to get my data from Emacs and my local machine to the remote server.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #a9b1d6;">(</span><span style="color: #bb9af7;">defun</span> <span style="color: #7aa2f7;">nao/export-org-to-blog</span> <span style="color: #7aa2f7;">()</span>
  <span style="color: #7aa2f7;">(</span><span style="color: #bb9af7;">interactive</span><span style="color: #7aa2f7;">)</span>
  <span style="color: #7aa2f7;">(</span><span style="color: #bb9af7;">setq</span> <span style="color: #c0caf5;">org-html-doctype</span> <span style="color: #9ece6a;">"html5"</span><span style="color: #7aa2f7;">)</span>
  <span style="color: #7aa2f7;">(</span><span style="color: #bb9af7;">let</span> <span style="color: #ff9e64;">(</span><span style="color: #73daca;">(</span>filename <span style="color: #a9b1d6;">(</span><span style="color: #ff9e64;">org-html-export-to-html</span> nil nil nil t<span style="color: #a9b1d6;">)</span><span style="color: #73daca;">)</span><span style="color: #ff9e64;">)</span>
    <span style="color: #ff9e64;">(</span><span style="color: #ff9e64;">copy-file</span> <span style="color: #73daca;">(</span><span style="color: #ff9e64;">concat</span> <span style="color: #a9b1d6;">(</span><span style="color: #ff9e64;">file-name-sans-extension</span> filename<span style="color: #a9b1d6;">)</span> <span style="color: #9ece6a;">".png"</span><span style="color: #73daca;">)</span>
               <span style="color: #9ece6a;">"/rsync:server:/path/to/images"</span> t<span style="color: #ff9e64;">)</span>
    <span style="color: #ff9e64;">(</span><span style="color: #ff9e64;">copy-file</span> filename <span style="color: #9ece6a;">"/rsync:server/path/to/html"</span> t<span style="color: #ff9e64;">)</span><span style="color: #7aa2f7;">)</span><span style="color: #a9b1d6;">)</span>
</pre>
</div>

<p>
Org mode also comes with a series of publish functions that, I am assuming, accomplish a similar task. This above function did almost exactly what I needed, so I haven&rsquo;t looked into the org publish functionality, but perhaps I will look into switching to that in the future if the website becomes more complicated.
</p>
</div>
</div>
<div id="outline-container-org0af1e85" class="outline-2">
<h2 id="org0af1e85">Bun REST api</h2>
<div class="outline-text-2" id="text-org0af1e85">
<p>
On the server I use a very simple REST api to direct traffic to resources by making use of <code>Bun.serve()</code>:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #bb9af7;">try</span> {
    <span style="color: #bb9af7;">if</span> (<span style="color: #9ece6a;">/\.(css|png|svg)$/</span>.test(req.url)) <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">await</span> getStatic(req.url);
    <span style="color: #bb9af7;">if</span> (url.pathname === <span style="color: #9ece6a;">"/"</span>) <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">await</span> getHome();
    <span style="color: #bb9af7;">if</span> (url.pathname === <span style="color: #9ece6a;">"/blog"</span>) <span style="color: #bb9af7;">return</span> getBlogs();
    <span style="color: #bb9af7;">if</span> (url.pathname === <span style="color: #9ece6a;">"/cards"</span>) <span style="color: #bb9af7;">return</span> getCards();
    <span style="color: #bb9af7;">if</span> (<span style="color: #9ece6a;">/\/blog\/.*\.html/</span>.test(req.url)) {
        <span style="color: #bb9af7;">const</span> <span style="color: #c0caf5;">match</span> = req.url.match(<span style="color: #9ece6a;">/\/blog\/(.*\.html)/</span>);
        <span style="color: #bb9af7;">return</span> getPost(
            match![<span style="color: #ff9e64; font-weight: bold;">1</span>],
            req.headers.get(<span style="color: #9ece6a;">"hx-request"</span>) === <span style="color: #9ece6a;">"true"</span>
        );
    }
    <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(<span style="color: #9ece6a;">"404!"</span>);
} <span style="color: #bb9af7;">catch</span> (e) {
    console.error(<span style="color: #9ece6a;">'Error:'</span>, e);
    <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(<span style="color: #9ece6a;">"500 - Internal Server Error"</span>);
}
</pre>
</div>

<p>
I took the basic structure from the Bun documentation and I use Regex tests to match routes. The first route matches routes with css or image filenames to server those images as they are requested and the other routes direct to modules where I use Mustache templates to create the response for the client.  <code>req.headers.get("hx-request") === "true"</code> being based to getPost() tests to see if a request has the hx-request header. I do this because I use <a href="https://htmx.org/">HTMX</a> to avoid page reloads, but I need a way to determine if a resource was requested from outside the page. If the header is not present, I know the user navigated from an external link so it knows whether or not it needs to serve the <code>index.html</code>.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #bb9af7;">if</span> (hx) {
    <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(post);
} <span style="color: #bb9af7;">else</span> {
    <span style="color: #bb9af7;">const</span> <span style="color: #c0caf5;">view</span> = {
        API_URL: API_URL,
        post: post,
    }

    <span style="color: #bb9af7;">const</span> <span style="color: #c0caf5;">html</span> = Mustache.render(index, view);

    <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(html, {
        headers: {
            <span style="color: #9ece6a;">"Content-Type"</span>: <span style="color: #9ece6a;">"text/html"</span>,
        },
    });
}
</pre>
</div>

<p>
inside <code>getPost()</code> if hx-request is true, I send just the HTML for the post, if its false, then I use Mustache to add the post to the index.html and send it as one HTML file.
</p>
</div>
</div>
<div id="outline-container-org6345fb2" class="outline-2">
<h2 id="org6345fb2">Serving Static Files</h2>
<div class="outline-text-2" id="text-org6345fb2">
<p>
The module that routes to the static file resources users regex similar to the main REST api:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #bb9af7;">if</span> (<span style="color: #9ece6a;">/\w+\.css$/</span>.test(filename)) {
    <span style="color: #bb9af7;">try</span> {
        <span style="color: #bb9af7;">const</span> <span style="color: #c0caf5;">file</span> = Bun.file(<span style="color: #9ece6a;">`static/css/${filename}`</span>);
        <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(file);
    } <span style="color: #bb9af7;">catch</span> (e) {
        console.error(e);
        <span style="color: #bb9af7;">return</span> <span style="color: #bb9af7;">new</span> <span style="color: #c0caf5;">Response</span>(<span style="color: #9ece6a;">"404: file not found"</span>);
    }
}
</pre>
</div>

<p>
<code>String.match()</code> extracts the filename from the url and then I use regex to map the file extensions to the appropriate directories and then return the requested file. The most likely reason for an error is that the file does not exist, but regardless of the error, I log the error on the server and respond with 404.
</p>
</div>
</div>
<div id="outline-container-orgae9a0bf" class="outline-2">
<h2 id="orgae9a0bf">Generating thumbnails</h2>
<div class="outline-text-2" id="text-orgae9a0bf">
<p>
Initially to create the images for the cards I was simply taking screenshots and then uploading the results as is. This meant that the files were much larger than they needed to be and slow to load. Furthermore, they were inconsistent in terms of size and aspect ratio making the cards inconsistently sized. In order to solve this problem, I installed <a href="https://sharp.pixelplumbing.com/">sharp</a> in order to transform the images, but I wanted a way to automate it.
</p>

<p>
I created a simple module to achieve this. First I took the <a href="https://bun.sh/guides/read-file/watch">example code</a> from the Bun documentation to watch my images directory for changes. When I use rsync to upload a new file the watch will trigger and provide me with the filename that was changed. I also add some logic to make sure that the file has appropriate extensions, in this case I check for png and jpg, and isn&rsquo;t a thumbnail itself.
</p>

<p>
Next I check to see if I have access to the file using <code>fs.access()</code>. If an image is moved from the directory, then sharp might try to transform an image that no longer exists, causing an error.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #bb9af7;">async</span> <span style="color: #bb9af7;">function</span> checkAccess(<span style="color: #c0caf5;">filename</span>: <span style="color: #c0caf5;">string</span>) {
    <span style="color: #bb9af7;">try</span> {
        <span style="color: #bb9af7;">await</span> access(<span style="color: #9ece6a;">`${imagesPath}/${filename}`</span>, constants.R_OK | constants.W_OK);
        resizeImage(filename);
    } <span style="color: #bb9af7;">catch</span> {
        <span style="color: #bb9af7;">return</span>;
    }
}
</pre>
</div>

<p>
Finally after everything has been appropriately validated, I check to see if there is already a thumbnail generated for that image, and if there is, I delete it so that, if the image has changed, the thumbnail will be updated appropriately. In theory this might cause an issue where, if the thumbnail is requested at the exact moment that I am remaking it, it would not be available. Perhaps a solution to this would be to create a separate staging directory and sync the images after they are updated. I may do this in the future if I create module for updating the post HTML to semantic HTML5.
</p>

<p>
I then run <code>sharp().resize()</code> with first two arguments being the width and height of the new image in pixels. In the options  argument, I set fit to &ldquo;cover&rdquo;, which has a similar effect to a CSS overflow hidden, but it will actually crop the image. This might cause it to be cropped in an undesirable way, but I think the best solution here is to crop the image properly before I upload it.
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #bb9af7;">async</span> <span style="color: #bb9af7;">function</span> resizeImage(<span style="color: #c0caf5;">filename</span>: <span style="color: #c0caf5;">string</span>) {
    <span style="color: #bb9af7;">const</span> <span style="color: #c0caf5;">images</span> = <span style="color: #bb9af7;">await</span> fs.readdir(imagesPath);
    <span style="color: #bb9af7;">if</span> (images.includes(<span style="color: #9ece6a;">`thumb-${filename}`</span>)) {
        <span style="color: #bb9af7;">try</span> {
            <span style="color: #bb9af7;">await</span> fs.rm(<span style="color: #9ece6a;">`${imagesPath}/thumb-${filename}`</span>);
            console.log(<span style="color: #9ece6a;">`Deleted old thumb for ${filename}`</span>);
        } <span style="color: #bb9af7;">catch</span> (e) {
            console.error(<span style="color: #9ece6a;">"Error deleting old thumb: "</span> + e);
        }
    }

    <span style="color: #bb9af7;">try</span> {
        console.log(<span style="color: #9ece6a;">`Processing image ${filename}`</span>);
        sharp(<span style="color: #9ece6a;">`${imagesPath}/${filename}`</span>)
            .resize(<span style="color: #ff9e64; font-weight: bold;">384</span>, <span style="color: #ff9e64; font-weight: bold;">185</span>, {
                fit: <span style="color: #9ece6a;">"cover"</span>,
            })
            .toFile(<span style="color: #9ece6a;">`${imagesPath}/thumb-${filename}`</span>);
    } <span style="color: #bb9af7;">catch</span> (e) {
        console.error(<span style="color: #9ece6a;">"File processing failed"</span> + e);
        <span style="color: #bb9af7;">return</span>;
    }
    console.log(<span style="color: #9ece6a;">`${filename} resized successfully`</span>);
}

</pre>
</div>
</div>
<div id="outline-container-org65e9569" class="outline-3">
<h3 id="org65e9569">fs.watch vs. chokidar</h3>
<div class="outline-text-3" id="text-org65e9569">
<p>
Another possible solution would be to use <a href="https://www.npmjs.com/package/chokidar">chokidar</a>. Chokidar still relies on <code>fs.watch()</code> and <code>fs.watchFile()</code>, but aims to resolve an issue where, depending on OS, the <code>eventType</code> returned by <code>fs.watch()</code> will always be &ldquo;Rename&rdquo; regardless of what is actually happening to the file. Since Chokidar still relies on the same fs methods as I am using, it is probably using similar techniques to return more appropriate events as I am using to validate that the file exists, which would indicate a move or delete event, and will add a dependency that is probably not really needed for the sake of saving a few lines of code. If I later find myself doing more extensive file system work that relies on <code>fs.watch()</code> I might reach for chokidar to avoid having write similar methods myself.
</p>
</div>
</div>
</div>


</div>

<footer>
  <div>
    <a href="/">Home</a>
    <a href="mailto: chris@chris-hughes.dev">Email</a>
    <div>
      <small>&copy; Chris Hughes 2025</small>
    </div>
  </div>
</footer>

</html>
